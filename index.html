<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>FocusMed</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" href="./favicon.png">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="theme-color" content="#080b12">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FocusMed">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #080b12;
  --s1:      #0f1520;
  --s2:      #151e30;
  --s3:      #1c2840;
  --border:  #232f45;
  --nutri:   #34d399;
  --nutri-d: rgba(52,211,153,0.10);
  --nutri-g: rgba(52,211,153,0.25);
  --ecg:     #38bdf8;
  --ecg-d:   rgba(56,189,248,0.10);
  --ecg-g:   rgba(56,189,248,0.25);
  --pause:   #a78bfa;
  --pause-d: rgba(167,139,250,0.12);
  --text:    #e2eaf8;
  --muted:   #4e6080;
  --muted2:  #7a8faa;
  --radius:  16px;
}

*{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'DM Sans',sans-serif;
  color:var(--text);
  background:var(--bg);
  min-height:100vh;
  /* subtle diagonal lines texture */
  background-image:
    repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 40px,
      rgba(255,255,255,0.012) 40px,
      rgba(255,255,255,0.012) 41px
    );
}

/* â”€â”€ LAYOUT â”€â”€ */
.app{
  width:min(100%,440px);
  margin:0 auto;
  padding:0 14px calc(84px + env(safe-area-inset-bottom));
}

/* â”€â”€ HEADER â”€â”€ */
.header{
  position:sticky;
  top:0;z-index:10;
  padding:16px 2px 12px;
  background:linear-gradient(180deg,rgba(8,11,18,.96) 70%,transparent);
  backdrop-filter:blur(12px);
  display:flex;justify-content:space-between;align-items:flex-start;
}
.header-title{
  font-family:'DM Serif Display',serif;
  font-size:26px;
  letter-spacing:-0.02em;
  line-height:1.1;
}
.header-sub{font-size:12px;color:var(--muted2);margin-top:3px}
.streak-badge{
  font-family:'DM Mono',monospace;
  font-size:11px;
  background:var(--s2);
  border:1px solid var(--border);
  padding:5px 11px;
  border-radius:20px;
  color:var(--muted2);
  white-space:nowrap;
  flex-shrink:0;
  margin-top:4px;
}

/* â”€â”€ VIEWS â”€â”€ */
.view{display:none;gap:12px;flex-direction:column}
.view.active{display:flex}

/* â”€â”€ CARD â”€â”€ */
.card{
  background:var(--s1);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
}
.card-title{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.1em;
  color:var(--muted);
  margin-bottom:14px;
}

/* â”€â”€ SUBJECT PILLS â”€â”€ */
.subject-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.subject-card{
  background:var(--s2);
  border:1.5px solid var(--border);
  border-radius:14px;
  padding:14px;
  cursor:pointer;
  transition:all .2s;
}
.subject-card.sel-nutri{border-color:var(--nutri);background:var(--nutri-d)}
.subject-card.sel-ecg  {border-color:var(--ecg);  background:var(--ecg-d)}
.subj-icon{font-size:20px;margin-bottom:6px}
.subj-name{font-size:13px;font-weight:600}
.subj-goal{font-size:11px;color:var(--muted2);margin-top:2px}
.subj-done{
  font-family:'DM Mono',monospace;
  font-size:21px;
  margin-top:8px;
}
.subj-done small{font-size:11px;color:var(--muted2)}

/* â”€â”€ RING TIMER â”€â”€ */
.timer-wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:6px 0 14px;
}
.ring-outer{position:relative;width:192px;height:192px;margin-bottom:14px}
.ring-outer svg{transform:rotate(-90deg)}
.ring-track{fill:none;stroke:var(--border);stroke-width:9}
.ring-fill{
  fill:none;stroke-width:9;stroke-linecap:round;
  stroke-dasharray:565;stroke-dashoffset:565;
  transition:stroke-dashoffset .9s linear,stroke .35s;
}
.timer-center{
  position:absolute;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  text-align:center;
}
.timer-digits{
  font-family:'DM Mono',monospace;
  font-size:38px;
  font-weight:500;
  letter-spacing:-0.02em;
  line-height:1;
}
.timer-phase{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:var(--muted2);
  margin-top:5px;
}

/* live pulse when running */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.timer-digits.live{animation:pulse 2s ease-in-out infinite}

/* â”€â”€ POMO DOTS â”€â”€ */
.pomo-row{display:flex;gap:5px;margin-bottom:16px}
.pomo-dot{
  width:9px;height:9px;border-radius:50%;
  background:var(--border);
  transition:background .3s,transform .2s;
}
.pomo-dot.done-nutri{background:var(--nutri);transform:scale(1.15)}
.pomo-dot.done-ecg  {background:var(--ecg);  transform:scale(1.15)}
.pomo-dot.cur       {border:2px solid var(--muted2);background:transparent}

/* â”€â”€ CONTROLS â”€â”€ */
.ctrl-row{display:flex;gap:10px;align-items:center;width:100%}
.btn-icon{
  width:46px;height:46px;flex-shrink:0;
  background:var(--s2);
  border:1px solid var(--border);
  border-radius:11px;
  color:var(--muted2);
  font-size:17px;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.btn-icon:hover{border-color:var(--text);color:var(--text)}
.btn-main{
  flex:1;
  padding:13px;
  border:none;
  border-radius:12px;
  font-family:'DM Sans',sans-serif;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:all .15s;
  letter-spacing:-0.01em;
}
.btn-main:active{transform:scale(0.97)}
.btn-nutri{background:var(--nutri);color:#060d15}
.btn-ecg  {background:var(--ecg);  color:#060d15}
.btn-pause{background:var(--pause);color:#060d15}
.btn-neutral{background:var(--s2);color:var(--text);border:1px solid var(--border)}

/* â”€â”€ PRESETS â”€â”€ */
.preset-row{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:7px;
  margin-bottom:14px;
}
.preset-btn{
  background:var(--s2);
  border:1.5px solid var(--border);
  border-radius:10px;
  color:var(--muted2);
  padding:9px 6px;
  font-family:'DM Sans',sans-serif;
  font-size:11px;
  font-weight:600;
  cursor:pointer;
  text-align:center;
  transition:all .2s;
}
.preset-btn .pb-name{font-size:12px;color:var(--text)}
.preset-btn.active-nutri{border-color:var(--nutri);background:var(--nutri-d);color:var(--nutri)}
.preset-btn.active-nutri .pb-name{color:var(--nutri)}
.preset-btn.active-ecg  {border-color:var(--ecg);  background:var(--ecg-d);  color:var(--ecg)}
.preset-btn.active-ecg   .pb-name{color:var(--ecg)}

/* â”€â”€ PROGRESS BARS â”€â”€ */
.prog-wrap{margin-bottom:12px}
.prog-wrap:last-child{margin-bottom:0}
.prog-head{display:flex;justify-content:space-between;font-size:12px;color:var(--muted2);margin-bottom:6px}
.prog-head strong{font-family:'DM Mono',monospace;font-size:12px;color:var(--text)}
.prog-track{height:6px;background:var(--s3);border-radius:3px;overflow:hidden}
.prog-fill{height:100%;border-radius:3px;transition:width .4s ease}
.pf-nutri{background:linear-gradient(90deg,var(--nutri),rgba(52,211,153,.6))}
.pf-ecg  {background:linear-gradient(90deg,var(--ecg),  rgba(56,189,248,.6))}

/* â”€â”€ DAILY PLAN â”€â”€ */
.plan-item{
  display:flex;
  gap:12px;
  padding:10px 0;
  border-bottom:1px solid var(--border);
}
.plan-item:last-child{border-bottom:none}
.plan-time{
  font-family:'DM Mono',monospace;
  font-size:11px;
  color:var(--muted2);
  width:52px;flex-shrink:0;
  padding-top:2px;
}
.plan-body{flex:1}
.plan-label{font-size:13px;font-weight:500}
.plan-detail{font-size:11px;color:var(--muted2);margin-top:2px}
.plan-pill{
  display:inline-block;
  font-size:10px;
  font-weight:600;
  padding:2px 8px;
  border-radius:20px;
  margin-top:4px;
}
.pp-nutri{background:var(--nutri-d);color:var(--nutri)}
.pp-ecg  {background:var(--ecg-d);  color:var(--ecg)}
.pp-pause{background:var(--pause-d);color:var(--pause)}

/* â”€â”€ TASKS â”€â”€ */
.task-input-row{display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:10px}
.task-input-row input,
.task-input-row select{
  background:var(--s2);
  border:1px solid var(--border);
  border-radius:10px;
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:13px;
  padding:10px 12px;
  min-height:44px;
  outline:none;
}
.task-input-row input:focus{border-color:var(--muted2)}
.task-input-row select{width:90px;cursor:pointer}
.btn-add{
  width:100%;
  padding:11px;
  background:var(--nutri);
  color:#060d15;
  border:none;
  border-radius:10px;
  font-family:'DM Sans',sans-serif;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:opacity .15s;
  margin-bottom:10px;
}
.btn-add:active{opacity:.8}
.task-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:11px 12px;
  background:var(--s2);
  border:1px solid var(--border);
  border-radius:11px;
  margin-bottom:7px;
}
.task-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.task-body{flex:1}
.task-text{font-size:13px;font-weight:500}
.task-meta{font-size:11px;color:var(--muted2);margin-top:2px}
.task-chip{
  font-size:10px;font-weight:700;
  padding:2px 8px;border-radius:20px;flex-shrink:0;
}
.chip-nutri{background:var(--nutri-d);color:var(--nutri)}
.chip-ecg  {background:var(--ecg-d);  color:var(--ecg)}
.task-del{
  background:none;border:none;
  color:var(--muted);font-size:16px;
  cursor:pointer;padding:4px;
  transition:color .15s;
}
.task-del:hover{color:var(--text)}
.empty-state{
  text-align:center;
  padding:30px;
  color:var(--muted);
  font-size:13px;
}

/* â”€â”€ STATS PAGE â”€â”€ */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.stat-box{
  background:var(--s2);
  border-radius:12px;
  padding:14px;
}
.stat-val{font-family:'DM Mono',monospace;font-size:24px;font-weight:500}
.stat-label{font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted2);margin-top:4px}

/* session log */
.session-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;
  background:var(--s2);
  border-radius:10px;
  margin-bottom:7px;
}
.sess-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sess-body{flex:1}
.sess-subj{font-size:13px;font-weight:500}
.sess-detail{font-size:11px;color:var(--muted2);margin-top:1px}
.sess-dur{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted2)}

/* â”€â”€ NAV â”€â”€ */
nav{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:min(calc(100% - 20px),420px);
  background:rgba(10,14,22,.92);
  border:1px solid var(--border);
  border-radius:18px;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:4px;
  padding:7px;
  backdrop-filter:blur(16px);
  z-index:100;
}
nav button{
  background:none;
  border:none;
  border-radius:11px;
  color:var(--muted);
  font-family:'DM Sans',sans-serif;
  font-size:10px;
  font-weight:500;
  letter-spacing:0.05em;
  text-transform:uppercase;
  padding:8px 4px;
  cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:3px;
  transition:all .15s;
}
nav button svg{width:18px;height:18px}
nav button.active{color:var(--text);background:var(--s2)}

/* â”€â”€ TOAST â”€â”€ */
.toast{
  position:fixed;top:16px;left:50%;
  transform:translateX(-50%) translateY(-80px);
  background:var(--s2);
  border:1px solid var(--border);
  border-radius:12px;
  padding:11px 20px;
  font-size:13px;font-weight:500;
  z-index:999;
  transition:transform .3s ease;
  white-space:nowrap;
  box-shadow:0 8px 32px rgba(0,0,0,.5);
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* â”€â”€ DIVIDER â”€â”€ */
.divider{
  display:flex;align-items:center;gap:8px;
  margin:6px 0 12px;
  font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);
}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* â”€â”€ DANGER BTN â”€â”€ */
.btn-danger{
  background:none;
  border:1px solid var(--border);
  border-radius:9px;
  color:var(--muted2);
  font-family:'DM Sans',sans-serif;
  font-size:13px;
  padding:10px 20px;
  cursor:pointer;
  transition:all .15s;
}
.btn-danger:hover{border-color:#ef4444;color:#ef4444}

</style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="app">

  <!-- HEADER -->
  <header class="header">
    <div>
      <div class="header-title">FocusMed</div>
      <div class="header-sub" id="hdr-date"></div>
    </div>
    <div class="streak-badge" id="streak-badge">ğŸ”¥ 0 giorni</div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â• VIEW: TIMER â•â•â•â•â•â•â•â•â•â• -->
  <div class="view active" id="view-timer">

    <!-- Subject selector -->
    <div class="subject-row">
      <div class="subject-card" id="sc-nutri" onclick="selectSubject('nutri')">
        <div class="subj-icon">ğŸ¥—</div>
        <div class="subj-name">Nutrizione</div>
        <div class="subj-goal">Target: <span id="nutri-goal-lbl">3h 30m</span></div>
        <div class="subj-done" id="nutri-done-lbl">0:00 <small>/ <span id="nutri-tgt">3h 30m</span></small></div>
      </div>
      <div class="subject-card" id="sc-ecg" onclick="selectSubject('ecg')">
        <div class="subj-icon">ğŸ’“</div>
        <div class="subj-name">ECG</div>
        <div class="subj-goal">Target: <span id="ecg-goal-lbl">45m</span></div>
        <div class="subj-done" id="ecg-done-lbl">0:00 <small>/ <span id="ecg-tgt">45m</span></small></div>
      </div>
    </div>

    <!-- Progress bars -->
    <div class="card">
      <div class="prog-wrap">
        <div class="prog-head"><span>ğŸ¥— Nutrizione</span><strong id="nutri-pct">0%</strong></div>
        <div class="prog-track"><div class="prog-fill pf-nutri" id="nutri-bar" style="width:0%"></div></div>
      </div>
      <div class="prog-wrap">
        <div class="prog-head"><span>ğŸ’“ ECG</span><strong id="ecg-pct">0%</strong></div>
        <div class="prog-track"><div class="prog-fill pf-ecg" id="ecg-bar" style="width:0%"></div></div>
      </div>
    </div>

    <!-- Timer card -->
    <div class="card">
      <!-- preset selector -->
      <div class="preset-row">
        <div class="preset-btn" data-preset="nutri45" onclick="selectPreset('nutri45',this)">
          <div class="pb-name">45/10</div>
          <div>Master</div>
        </div>
        <div class="preset-btn" data-preset="ecg30" onclick="selectPreset('ecg30',this)">
          <div class="pb-name">30/5</div>
          <div>ECG</div>
        </div>
        <div class="preset-btn" data-preset="deep60" onclick="selectPreset('deep60',this)">
          <div class="pb-name">60/10</div>
          <div>Deep</div>
        </div>
      </div>

      <!-- ring -->
      <div class="timer-wrap">
        <div class="pomo-row" id="pomo-dots"></div>

        <div class="ring-outer">
          <svg viewBox="0 0 192 192" width="192" height="192">
            <circle class="ring-track" cx="96" cy="96" r="84"/>
            <circle class="ring-fill" id="ring" cx="96" cy="96" r="84"/>
          </svg>
          <div class="timer-center">
            <div class="timer-digits" id="timer-digits">45:00</div>
            <div class="timer-phase"  id="timer-phase">Seleziona materia</div>
          </div>
        </div>

        <div class="ctrl-row">
          <div class="btn-icon" onclick="resetTimer()" title="Reset">â†º</div>
          <button class="btn-main btn-neutral" id="btn-start" onclick="toggleTimer()">Avvia</button>
          <div class="btn-icon" onclick="skipPhase()" title="Salta">â­</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• VIEW: PIANO â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-piano">
    <div class="card">
      <div class="card-title">Piano del giorno</div>
      <div id="plan-list"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• VIEW: TASK â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-task">
    <div class="card">
      <div class="card-title">Task rapidi</div>
      <div class="task-input-row">
        <input id="task-input" type="text" placeholder="Es. ECG: blocco AV tipo 2â€¦">
        <select id="task-type">
          <option value="nutri">ğŸ¥—</option>
          <option value="ecg">ğŸ’“</option>
        </select>
      </div>
      <button class="btn-add" onclick="addTask()">Aggiungi</button>
      <div id="task-list"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• VIEW: STATS â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-stats">
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-val" id="st-total">0:00</div>
        <div class="stat-label">Totale oggi</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="st-pomos">0</div>
        <div class="stat-label">Sessioni</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="st-nutri">0:00</div>
        <div class="stat-label">Nutrizione</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="st-ecg">0:00</div>
        <div class="stat-label">ECG</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Sessioni di oggi</div>
      <div id="session-log"><div class="empty-state">Nessuna sessione ancora</div></div>
    </div>

    <div style="text-align:center">
      <button class="btn-danger" onclick="resetDay()">Azzera giornata</button>
    </div>
  </div>

</div><!-- /app -->

<!-- NAV -->
<nav>
  <button class="active" data-view="timer" onclick="goView('timer',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Timer
  </button>
  <button data-view="piano" onclick="goView('piano',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Piano
  </button>
  <button data-view="task" onclick="goView('task',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
    Task
  </button>
  <button data-view="stats" onclick="goView('stats',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    Stats
  </button>
</nav>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PRESETS = {
  nutri45: { study:45*60, breakS:10*60, breakL:20*60, subject:'nutri', label:'Master 45/10' },
  ecg30:   { study:30*60, breakS:5*60,  breakL:10*60, subject:'ecg',   label:'ECG 30/5' },
  deep60:  { study:60*60, breakS:10*60, breakL:20*60, subject:'nutri', label:'Deep 60/10' },
};

const GOALS = { nutri: 210, ecg: 45 }; // minutes - editable

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let S = {
  // timer
  preset:   'nutri45',
  subject:  null,        // 'nutri' | 'ecg'
  phase:    'focus',     // 'focus' | 'break-s' | 'break-l'
  running:  false,
  remaining: 45*60,
  totalSecs: 45*60,

  // progress (seconds for live accuracy)
  nutriSecs: 0,
  ecgSecs:   0,

  // cycles
  sessionsCompleted: 0,

  // log
  sessions: [],
  tasks:    [],

  // streak
  streak: 0,
};

let ticker = null;
const CIRC = Math.PI * 2 * 84; // â‰ˆ 527.8

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const KEY = 'focusmed_v3';

function save() {
  localStorage.setItem(KEY, JSON.stringify({
    date:     new Date().toDateString(),
    nutriSecs: S.nutriSecs,
    ecgSecs:   S.ecgSecs,
    sessions:  S.sessions,
    tasks:     S.tasks,
    streak:    S.streak,
    sessionsCompleted: S.sessionsCompleted,
  }));
}

function load() {
  try {
    const d = JSON.parse(localStorage.getItem(KEY)||'{}');
    const today = new Date().toDateString();
    if (d.date === today) {
      S.nutriSecs = d.nutriSecs || 0;
      S.ecgSecs   = d.ecgSecs   || 0;
      S.sessions  = d.sessions  || [];
      S.tasks     = d.tasks     || [];
      S.streak    = d.streak    || 0;
      S.sessionsCompleted = d.sessionsCompleted || 0;
    } else {
      // new day: check streak
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
      const wasYesterday = d.date === yesterday.toDateString();
      const metGoal = (d.nutriSecs||0) >= GOALS.nutri * 60;
      S.streak = (wasYesterday && metGoal) ? (d.streak||0)+1 : 0;
      save();
    }
  } catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUBJECT SELECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectSubject(sub) {
  if (S.running) { toast('Ferma il timer prima âœ‹'); return; }
  S.subject = sub;
  S.phase = 'focus';

  document.getElementById('sc-nutri').className = 'subject-card' + (sub==='nutri'?' sel-nutri':'');
  document.getElementById('sc-ecg').className   = 'subject-card' + (sub==='ecg'  ?' sel-ecg':'');

  updateBtnColor();
  updatePhaseLabel();
  updateRing();
}

function selectPreset(name, el) {
  if (S.running) { toast('Ferma il timer prima âœ‹'); return; }
  S.preset = name;
  const p = PRESETS[name];

  // auto-select subject
  S.subject = p.subject;
  document.getElementById('sc-nutri').className = 'subject-card' + (p.subject==='nutri'?' sel-nutri':'');
  document.getElementById('sc-ecg').className   = 'subject-card' + (p.subject==='ecg'  ?' sel-ecg':'');

  // update preset buttons
  document.querySelectorAll('.preset-btn').forEach(b => {
    b.className = 'preset-btn';
    if (b.dataset.preset === name) {
      b.classList.add(p.subject==='nutri'?'active-nutri':'active-ecg');
    }
  });

  S.phase = 'focus';
  S.remaining = p.study;
  S.totalSecs = p.study;

  updateBtnColor();
  updatePhaseLabel();
  updateTimerDisplay();
  updateRing();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER CORE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleTimer() {
  if (!S.subject) { toast('Seleziona una materia prima! ğŸ‘†'); return; }
  S.running = !S.running;

  if (S.running) {
    ticker = setInterval(tick, 1000);
    document.getElementById('timer-digits').classList.add('live');
    document.getElementById('btn-start').textContent = 'Pausa';
  } else {
    clearInterval(ticker);
    document.getElementById('timer-digits').classList.remove('live');
    document.getElementById('btn-start').textContent = 'Riprendi';
  }
}

function tick() {
  // LIVE SYNC: credit time while studying
  if (S.phase === 'focus') {
    if (S.subject === 'nutri') S.nutriSecs++;
    else                        S.ecgSecs++;
    updateProgressUI();
  }

  S.remaining--;
  updateTimerDisplay();
  updateRing();

  if (S.remaining <= 0) phaseEnd();
}

function phaseEnd() {
  clearInterval(ticker);
  S.running = false;
  document.getElementById('timer-digits').classList.remove('live');
  playSound();

  if (S.phase === 'focus') {
    S.sessionsCompleted++;
    const p = PRESETS[S.preset];
    // log session
    S.sessions.push({
      subject:  S.subject,
      duration: Math.round(p.study/60),
      time:     now(),
      type:     'complete',
    });
    buildPomodoDots();
    renderSessionLog();
    renderStats();

    // choose break
    const isLong = S.sessionsCompleted % 3 === 0;
    S.phase = isLong ? 'break-l' : 'break-s';
    S.totalSecs = isLong ? p.breakL : p.breakS;
    const bm = Math.round(S.totalSecs/60);
    toast(isLong ? `ğŸ‰ Pausa lunga! ${bm} min meritati` : `âœ… Sessione! Pausa ${bm}min â˜•`);

    document.getElementById('btn-start').textContent = 'Avvia pausa';
    document.getElementById('btn-start').className = 'btn-main btn-pause';
  } else {
    // break done
    const p = PRESETS[S.preset];
    S.phase = 'focus';
    S.totalSecs = p.study;
    toast('ğŸ’ª Pausa finita â€” riparti!');
    updateBtnColor();
    document.getElementById('btn-start').textContent = 'Avvia';
  }

  S.remaining = S.totalSecs;
  updatePhaseLabel();
  updateTimerDisplay();
  updateRing();
  save();
}

function resetTimer() {
  if (S.running) { clearInterval(ticker); S.running = false; }
  document.getElementById('timer-digits').classList.remove('live');
  S.phase = 'focus';
  const p = PRESETS[S.preset];
  S.remaining = p.study;
  S.totalSecs = p.study;
  updateBtnColor();
  updatePhaseLabel();
  updateTimerDisplay();
  updateRing();
  document.getElementById('btn-start').textContent = 'Avvia';
}

function skipPhase() {
  if (S.running) { clearInterval(ticker); S.running = false; }
  document.getElementById('timer-digits').classList.remove('live');

  if (S.phase === 'focus') {
    // log partial (min 1 min)
    const elapsed = Math.floor((S.totalSecs - S.remaining)/60);
    if (elapsed >= 1) {
      if (S.subject === 'nutri') S.nutriSecs += elapsed*60;
      else                        S.ecgSecs   += elapsed*60;
      S.sessions.push({ subject: S.subject, duration: elapsed, time: now(), type: 'partial' });
      S.sessionsCompleted++;
      buildPomodoDots();
      renderSessionLog();
      renderStats();
      updateProgressUI();
      save();
    }
    const isLong = S.sessionsCompleted % 3 === 0;
    S.phase = isLong ? 'break-l' : 'break-s';
    S.totalSecs = isLong ? PRESETS[S.preset].breakL : PRESETS[S.preset].breakS;
    document.getElementById('btn-start').textContent = 'Avvia pausa';
    document.getElementById('btn-start').className = 'btn-main btn-pause';
  } else {
    S.phase = 'focus';
    S.totalSecs = PRESETS[S.preset].study;
    updateBtnColor();
    document.getElementById('btn-start').textContent = 'Avvia';
  }

  S.remaining = S.totalSecs;
  updatePhaseLabel();
  updateTimerDisplay();
  updateRing();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateTimerDisplay() {
  const m = String(Math.floor(S.remaining/60)).padStart(2,'0');
  const s = String(S.remaining%60).padStart(2,'0');
  document.getElementById('timer-digits').textContent = `${m}:${s}`;
}

function updateRing() {
  const pct = S.remaining / S.totalSecs;
  const offset = CIRC * pct;
  const ring = document.getElementById('ring');
  ring.style.strokeDasharray  = CIRC;
  ring.style.strokeDashoffset = CIRC - offset;

  let color = 'var(--nutri)';
  if (S.phase === 'break-s' || S.phase === 'break-l') color = 'var(--pause)';
  else if (S.subject === 'ecg') color = 'var(--ecg)';
  ring.style.stroke = color;
}

function updatePhaseLabel() {
  const map = {
    'focus':   S.subject ? `Focus ${S.subject==='nutri'?'Nutrizione':'ECG'}` : 'Seleziona materia',
    'break-s': 'Pausa breve â˜•',
    'break-l': 'Pausa lunga ğŸ§˜',
  };
  document.getElementById('timer-phase').textContent = map[S.phase]||'';
}

function updateBtnColor() {
  const btn = document.getElementById('btn-start');
  btn.className = 'btn-main ' + (S.subject==='ecg' ? 'btn-ecg' : S.subject==='nutri' ? 'btn-nutri' : 'btn-neutral');
}

function buildPomodoDots() {
  const row = document.getElementById('pomo-dots');
  const total = 8;
  row.innerHTML = '';
  for (let i = 0; i < total; i++) {
    const d = document.createElement('div');
    d.className = 'pomo-dot';
    if (i < S.sessionsCompleted % total) {
      d.classList.add(S.subject==='ecg' ? 'done-ecg' : 'done-nutri');
    } else if (i === S.sessionsCompleted % total && S.phase==='break-s') {
      d.classList.add('cur');
    }
    row.appendChild(d);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateProgressUI() {
  const nm = S.nutriSecs/60, em = S.ecgSecs/60;
  const ng = GOALS.nutri, eg = GOALS.ecg;

  const npct = Math.min(100, Math.round(nm/ng*100));
  const epct = Math.min(100, Math.round(em/eg*100));

  document.getElementById('nutri-bar').style.width = npct+'%';
  document.getElementById('ecg-bar').style.width   = epct+'%';
  document.getElementById('nutri-pct').textContent = npct+'%';
  document.getElementById('ecg-pct').textContent   = epct+'%';

  document.getElementById('nutri-done-lbl').innerHTML = formatSecs(S.nutriSecs,true)+' <small>/ <span id="nutri-tgt">'+fmtGoal(ng)+'</span></small>';
  document.getElementById('ecg-done-lbl').innerHTML   = formatSecs(S.ecgSecs,  true)+' <small>/ <span id="ecg-tgt">'+fmtGoal(eg)+'</span></small>';
}

function renderGoalLabels() {
  document.getElementById('nutri-goal-lbl').textContent = fmtGoal(GOALS.nutri);
  document.getElementById('ecg-goal-lbl').textContent   = fmtGoal(GOALS.ecg);
  document.getElementById('nutri-tgt').textContent      = fmtGoal(GOALS.nutri);
  document.getElementById('ecg-tgt').textContent        = fmtGoal(GOALS.ecg);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DAILY PLAN (dynamic)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPlan() {
  const plan = [];
  let cur = 9*60; // start 09:00

  const p = PRESETS['nutri45'];
  const focusMins = p.study/60;
  const nutriGoal = GOALS.nutri;
  const ecgGoal   = GOALS.ecg;

  // Split nutrizione: first half morning, second half afternoon
  const half1 = Math.ceil(nutriGoal/2);
  const half2 = nutriGoal - half1;

  function addBlock(type, label, detail, dur) {
    plan.push({ type, label, detail, dur, start: cur });
    cur += dur;
  }

  // MORNING: Nutrizione session 1
  const np1 = Math.ceil(half1/focusMins);
  for (let i = 0; i < np1; i++) {
    addBlock('nutri', `Focus Nutrizione #${i+1}`, `Pomodoro ${i+1}/${np1}`, focusMins);
    if (i < np1-1) {
      const bl = (i+1)%3===0;
      addBlock('pause', bl?'Pausa lunga':'Pausa breve', bl?'Muoviti, idratati':'Acqua, respira', bl?20:10);
    }
  }

  // Pranzo
  addBlock('pause','Pranzo & Riposo','Stacca completamente',60);

  // ECG
  const ep = Math.ceil(ecgGoal/30); // 30min blocks
  for (let i = 0; i < ep; i++) {
    const d = Math.min(30, ecgGoal-i*30);
    addBlock('ecg', `Focus ECG #${i+1}`, `Interpretazione tracciati â€” blocco ${i+1}`, d);
    if (i < ep-1) addBlock('pause','Pausa breve','5 min',5);
  }

  // AFTERNOON: Nutrizione session 2
  addBlock('pause','Mini pausa','Prepara il secondo blocco',15);
  const np2 = Math.ceil(half2/focusMins);
  for (let i = 0; i < np2; i++) {
    addBlock('nutri', `Focus Nutrizione #${np1+i+1}`, `Pomodoro ${i+1}/${np2}`, focusMins);
    if (i < np2-1) {
      const bl = (i+1)%3===0;
      addBlock('pause', bl?'Pausa lunga':'Pausa breve', '',bl?20:10);
    }
  }

  const container = document.getElementById('plan-list');
  container.innerHTML = plan.map(b => {
    const h = Math.floor(b.start/60), m = b.start%60;
    const t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    const pillCls = b.type==='nutri'?'pp-nutri':b.type==='ecg'?'pp-ecg':'pp-pause';
    const pillTxt = b.type==='nutri'?'Nutrizione':b.type==='ecg'?'ECG':'Pausa';
    return `
      <div class="plan-item">
        <div class="plan-time">${t}</div>
        <div class="plan-body">
          <div class="plan-label">${b.label}</div>
          <div class="plan-detail">${b.detail} Â· ${b.dur}min</div>
          <span class="plan-pill ${pillCls}">${pillTxt}</span>
        </div>
      </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addTask() {
  const input = document.getElementById('task-input');
  const text  = input.value.trim();
  if (!text) { toast('Scrivi qualcosa prima ğŸ“'); return; }
  const type = document.getElementById('task-type').value;
  S.tasks.unshift({ text, type, time: now() });
  input.value = '';
  save();
  renderTasks();
}

function removeTask(idx) {
  S.tasks.splice(idx,1);
  save();
  renderTasks();
}

function renderTasks() {
  const container = document.getElementById('task-list');
  if (!S.tasks.length) {
    container.innerHTML = '<div class="empty-state">Nessun task â€” aggiungine uno sopra</div>';
    return;
  }
  container.innerHTML = S.tasks.map((t,i) => `
    <div class="task-item">
      <div class="task-dot" style="background:${t.type==='nutri'?'var(--nutri)':'var(--ecg)'}"></div>
      <div class="task-body">
        <div class="task-text">${t.text}</div>
        <div class="task-meta">${t.time}</div>
      </div>
      <span class="task-chip ${t.type==='nutri'?'chip-nutri':'chip-ecg'}">${t.type==='nutri'?'ğŸ¥—':'ğŸ’“'}</span>
      <button class="task-del" onclick="removeTask(${i})">âœ“</button>
    </div>
  `).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStats() {
  const total = S.nutriSecs + S.ecgSecs;
  document.getElementById('st-total').textContent = formatSecs(total,true);
  document.getElementById('st-pomos').textContent = S.sessionsCompleted;
  document.getElementById('st-nutri').textContent = formatSecs(S.nutriSecs,true);
  document.getElementById('st-ecg').textContent   = formatSecs(S.ecgSecs,  true);
}

function renderSessionLog() {
  const container = document.getElementById('session-log');
  if (!S.sessions.length) {
    container.innerHTML = '<div class="empty-state">Nessuna sessione ancora</div>';
    return;
  }
  container.innerHTML = [...S.sessions].reverse().map(s => `
    <div class="session-item">
      <div class="sess-dot" style="background:${s.subject==='nutri'?'var(--nutri)':'var(--ecg)'}"></div>
      <div class="sess-body">
        <div class="sess-subj">${s.subject==='nutri'?'ğŸ¥— Nutrizione':'ğŸ’“ ECG'}</div>
        <div class="sess-detail">${s.time} Â· ${s.type==='partial'?'parziale':'completa'}</div>
      </div>
      <div class="sess-dur">${s.duration}min</div>
    </div>
  `).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goView(name, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  btn.classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function formatSecs(secs, short=false) {
  secs = Math.max(0, Math.floor(secs));
  const m = Math.floor(secs/60);
  const h = Math.floor(m/60);
  const rm = m%60;
  if (short) return h ? `${h}:${String(rm).padStart(2,'0')}` : `${m}m`;
  return h ? `${h}h ${rm}m` : `${m}m`;
}

function fmtGoal(mins) {
  if (mins<60) return mins+'m';
  const h=Math.floor(mins/60), m=mins%60;
  return m ? `${h}h ${m}m` : `${h}h`;
}

function now() {
  return new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
}

let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

function playSound() {
  try {
    const ctx = new(window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.frequency.setValueAtTime(880, ctx.currentTime);
    osc.frequency.setValueAtTime(660, ctx.currentTime+.12);
    osc.frequency.setValueAtTime(880, ctx.currentTime+.24);
    g.gain.setValueAtTime(.25, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(.001, ctx.currentTime+.6);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime+.6);
  } catch(e){}
}

function resetDay() {
  if (!confirm('Sei sicuro? Tutti i dati di oggi verranno cancellati.')) return;
  S.nutriSecs = 0; S.ecgSecs = 0;
  S.sessions = []; S.sessionsCompleted = 0;
  clearInterval(ticker); S.running = false;
  S.phase = 'focus'; S.subject = null;
  document.getElementById('sc-nutri').className = 'subject-card';
  document.getElementById('sc-ecg').className   = 'subject-card';
  document.getElementById('timer-digits').classList.remove('live');
  updateBtnColor();
  updateProgressUI(); updatePhaseLabel(); renderStats(); renderSessionLog(); buildPomodoDots();
  resetTimer(); save();
  toast('Dati azzerati âœ“');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  load();

  // date
  document.getElementById('hdr-date').textContent =
    new Date().toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('streak-badge').textContent = 'ğŸ”¥ '+S.streak+' giorni';

  // set default preset button active
  document.querySelector('[data-preset="nutri45"]').classList.add('active-nutri');

  renderGoalLabels();
  updateProgressUI();
  updateTimerDisplay();
  updatePhaseLabel();
  updateRing();
  buildPomodoDots();
  buildPlan();
  renderTasks();
  renderStats();
  renderSessionLog();

  // task input enter
  document.getElementById('task-input').addEventListener('keydown', e => {
    if (e.key==='Enter') addTask();
  });

  // request notification permission
  if ('Notification' in window && Notification.permission==='default') {
    Notification.requestPermission();
  }
}

init();

  // Register Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }
</script>
</body>
</html>
